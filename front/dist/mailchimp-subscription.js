// Generated by CoffeeScript 1.10.0

/*
 * Copyright (C) 2014-2016 Andrey Antukh <niwi@niwi.nz>
 * Copyright (C) 2014-2016 Jesús Espino Garcia <jespinog@gmail.com>
 * Copyright (C) 2014-2016 David Barragán Merino <bameda@dbarragan.com>
 * Copyright (C) 2014-2016 Alejandro Alonso <alejandro.alonso@kaleidos.net>
 * Copyright (C) 2014-2016 Juan Francisco Alcántara <juanfran.alcantara@kaleidos.net>
 * Copyright (C) 2014-2016 Xavi Julian <xavier.julian@kaleidos.net>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 *
 * File: mailchimp-subscription.coffee
 */

(function() {
  var decorator, template;

  template = "<a class=\"close\" href=\"\" title=\"close\">\n    <span class=\"icon icon-delete\"></span>\n</a>\n<form>\n    <h2 class=\"title\", translate=\"LIGHTBOX.DELETE_ACCOUNT.SECTION_NAME\"></h2>\n    <p>\n        <span class=\"question\" translate=\"LIGHTBOX.DELETE_ACCOUNT.CONFIRM\"></span>\n        <span class=\"subtitle\" translate=\"LIGHTBOX.DELETE_ACCOUNT.SUBTITLE\"></span>\n    </p>\n\n    <div class=\"newsletter\">\n        <input name=\"unsuscribe\", type=\"checkbox\", id=\"unsuscribe\" />\n        <label for=\"unsuscribe\" translate=\"LIGHTBOX.DELETE_ACCOUNT.NEWSLETTER_LABEL_TEXT\"></label>\n    </div>\n\n    <div class=\"options\">\n        <a class=\"button-green\" href=\"\" title=\"{{'COMMON.ACCEPT' | translate}}\")>\n            <span translate=\"COMMON.ACCEPT\"></span>\n        <a class=\"button-red\" href=\"\" title=\"{{'COMMON.CANCEL' | translate}}\">\n            <span translate=\"COMMON.CANCEL\"></span>\n        </a>\n    </div>\n</form>";

  decorator = [
    '$delegate', '$tgRepo', '$tgAuth', '$tgLocation', '$tgNavUrls', 'lightboxService', function($delegate, $repo, $auth, $location, $navUrls, lightboxService) {
      var directive;
      directive = $delegate[0];
      directive.template = template;
      directive.templateUrl = null;
      directive.compile = function() {
        return function($scope, $el, $attrs) {
          var submit;
          $scope.$on("deletelightbox:new", function(ctx, user) {
            return lightboxService.open($el);
          });
          $scope.$on("$destroy", function() {
            return $el.off();
          });
          submit = function() {
            var params, promise, unsuscribe;
            unsuscribe = $el.find("input[name='unsuscribe']").is(':checked');
            params = {};
            if (unsuscribe) {
              params["unsuscribe"] = unsuscribe;
            }
            promise = $repo.remove($scope.user, params);
            promise.then(function(data) {
              lightboxService.close($el);
              $auth.logout();
              return $location.path($navUrls.resolve("login"));
            });
            return promise.then(null, function() {
              return console.log("FAIL");
            });
          };
          $el.on("click", ".button-red", function(event) {
            event.preventDefault();
            return lightboxService.close($el);
          });
          return $el.on("click", ".button-green", window.taiga.debounce(2000, function(event) {
            event.preventDefault();
            return submit();
          }));
        };
      };
      return $delegate;
    }
  ];

  window.addDecorator("tgLbDeleteUserDirective", decorator);

}).call(this);
